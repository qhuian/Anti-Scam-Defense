import requests
import json
import os
from datetime import datetime

API_URL = "https://mb-api.abuse.ch/api/v1/"
DB_FILE = "malware_db.json"

def fetch_recent_android_malware():
    # Simpleng query para iwas error
    data = {
        "query": "get_taginfo",
        "tag": "apk",
        "limit": 50
    }
    try:
        response = requests.post(API_URL, data=data, timeout=15)
        if response.status_code == 200:
            json_resp = response.json()
            if json_resp.get("query_status") == "ok":
                return json_resp.get("data", [])
        return []
    except Exception as e:
        print(f"Error fetching: {e}")
        return []

def update_database():
    new_malware = fetch_recent_android_malware()
    
    # Load existing DB
    if os.path.exists(DB_FILE):
        try:
            with open(DB_FILE, 'r') as f:
                db = json.load(f)
        except:
            db = {"signatures": []}
    else:
        db = {"signatures": []}

    if "signatures" not in db:
        db["signatures"] = []

    existing_hashes = {item['hash_value'] for item in db['signatures']}
    count = 0

    for item in new_malware:
        sha256 = item.get("sha256_hash")
        if not sha256 or sha256 in existing_hashes:
            continue
            
        new_entry = {
            "hash_value": sha256,
            "malware_name": f"Android.{item.get('signature', 'Generic')}",
            "description": f"Type: {item.get('file_type_mime', 'APK')}. Source: MalwareBazaar",
            "source": "Automated Feed"
        }
        
        db['signatures'].append(new_entry)
        existing_hashes.add(sha256)
        count += 1

    if count > 0:
        db['version'] = datetime.now().strftime("%Y.%m.%d-Auto")
        with open(DB_FILE, 'w') as f:
            json.dump(db, f, indent=2)
        print(f"Added {count} signatures.")
    else:
        print("No new signatures added.")

if __name__ == "__main__":
    update_database()
    
