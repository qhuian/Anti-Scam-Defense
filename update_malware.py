import requests
import json
import os
from datetime import datetime

# URL ng MalwareBazaar API
API_URL = "https://mb-api.abuse.ch/api/v1/"

# File na ia-update
DB_FILE = "malware_db.json"

def fetch_recent_android_malware():
    # Kukuha ng recent malware na APK ang file type
    data = {
        "query": "get_file_type",
        "file_type": "apk",
        "limit": 100  # Kukuha ng 100 recent viruses daily
    }
    
    try:
        response = requests.post(API_URL, data=data)
        if response.status_code == 200:
            return response.json().get("data", [])
        else:
            print(f"Error fetching data: {response.status_code}")
            return []
    except Exception as e:
        print(f"Exception occurred: {e}")
        return []

def update_database():
    new_malware = fetch_recent_android_malware()
    
    if not new_malware:
        print("No new malware found or API error.")
        return

    # Load existing DB o gumawa ng bago kung wala pa
    if os.path.exists(DB_FILE):
        with open(DB_FILE, 'r') as f:
            try:
                db = json.load(f)
            except json.JSONDecodeError:
                db = {"signatures": []}
    else:
        db = {"signatures": []}

    # Kunin ang existing hashes para iwas duplicate
    existing_hashes = {item['hash_value'] for item in db.get('signatures', [])}
    
    count_added = 0
    
    for item in new_malware:
        sha256 = item.get("sha256_hash")
        
        # Skip kung nasa database na
        if sha256 in existing_hashes:
            continue
            
        # I-format sa structure ng app mo
        # MalwareBazaar usually gives generic names like 'apk', so we check tags
        tags = item.get("tags") or []
        malware_name = tags[0] if tags else item.get("reporter", "Unknown") + " Malware"
        
        new_entry = {
            "hash_value": sha256,
            "malware_name": f"Android.{malware_name}",
            "description": f"Detected via MalwareBazaar. Type: {item.get('file_type_mime')}",
            "source": "MalwareBazaar API"
        }
        
        db['signatures'].append(new_entry)
        existing_hashes.add(sha256)
        count_added += 1

    # Update Version Date
    db['version'] = datetime.now().strftime("%Y.%m.%d-AutoUpdate")

    # Save changes
    with open(DB_FILE, 'w') as f:
        json.dump(db, f, indent=2)
    
    print(f"Successfully added {count_added} new signatures.")

if __name__ == "__main__":
    update_database()
  
